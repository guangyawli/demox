{% extends 'base.html' %}
{% load static %}
{% block title %}我的作品{% endblock  %}
{% block STYLEcontent %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf_viewer.min.css" />
{% endblock %}
{% block error_content %}
    <div class="container-fluid">
        {% if error_message %}
            <div>{{ error_message }}</div>
        {% endif %}
        {% if error_link %}
            <p>Please click <a href="{% url error_link %}">here</a>
        {% endif %}

    </div>
{% endblock %}
{% block content %}
    {% if files %}
        <p>修改檔案 click <a href="{% url 'add_files' %}">here</a></p>

      <section class="bottom" id="table-section">
        <div class="container">
            <h2 class="title">我的作品</h2>
            <p class="sub_title">檢視我的個人作品</p>
            <div class="content-box table-responsive">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" id="pdf-tab" data-toggle="tab" href="#pdf" role="tab" aria-controls="pdf" aria-selected="true">作品說明文件</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="youtube-tab" data-toggle="tab" href="#youtube" role="tab" aria-controls="profile" aria-selected="false">作品影片</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="affidavit-tab" data-toggle="tab" href="#affidavit" role="tab" aria-controls="contact" aria-selected="false">競賽切結書</a>
                  </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                  <div class="tab-pane fade show active" id="pdf" role="tabpanel" aria-labelledby="pdf-tab">
                       <div class="page_title fw9" id="pdf-box">

                            <i id="previous_button" onclick="previousPage()" class="fas fa-arrow-alt-circle-left pni cursor-pointer"></i>
                            <span id="current_page"></span>/<span id="total_page"></span>
                            <i id="next_button" onclick="nextPage()" class="fas fa-arrow-alt-circle-right pni cursor-pointer"></i>
                            <canvas id="the-canvas"></canvas>
                        </div>
                  </div>

                  <div class="tab-pane fade" id="youtube" role="tabpanel" aria-labelledby="youtube-tab">
                      {% if files.video_link %}
                          <a href="{{ files.video_link }}">{{ files.video_link }}</a>
                      {% endif %}
                      <div class="youtube_container">

                          <iframe src="https://www.youtube.com/embed/cDSyHVPo3ZA" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="video"></iframe>
                      </div>
                  </div>

                  <div class="tab-pane fade" id="affidavit" role="tabpanel" aria-labelledby="affidavit-tab">
                      {% if files.affidavit %}
                          <a href="{{ files.affidavit.url }}">競賽切結書.pdf</a>
                      {% else %}
                          <p class="sub_title">未上傳檔案</p>
                      {% endif %}
                  </div>
                </div>
            </div>
        </div>
      </section>
    {% else %}
        <section class="bottom" id="table-section">
        <div class="container">
            <h2 class="title">檔案上傳</h2>
            <p class="sub_title">新增檔案</p>
            <div class="content-box table-responsive">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                      <h3 class="title">隊伍資料</h3>
                      <div class="form-row">
                        <div class="col-md-6 mb-3">
                          <label for="validationDefault02">隊伍主題</label>
                          {{ post_form.team_topic }}
                        </div>
                        <div class="col-md-6 mb-3">
                          <label for="validationDefault02">作品說明書</label>
                          {{ post_form.readme }}
                        </div>
                        <div class="col-md-3 mb-3">
                          <label for="validationDefault02">切結書</label>
                          {{ post_form.affidavit }}
                        </div>
                        <div class="col-md-3 mb-3">
                          <label for="validationDefault02">影片連結</label>
                          {{ post_form.video_link }}
                        </div>
                      </div>
                      <hr>
                    <button class="btn btn-primary" type="submit">送出</button>

                </form>
            </div>
        </div>
    </section>
    {% endif %}
    {#{% if files %}#}
    {#<table class="table table-striped">#}
    {#    <tbody>#}
    {#    <tr>#}
    {#        <td>Filename & URL</td>#}
    {#        <td>Filesize</td>#}
    {#        <td>Upload Method</td>#}
    {#    </tr>#}
    {#    {% for file in files %}#}
    {#    <tr>#}
    {#        <td><a href="{{ file.file.url }}">{{ file.file.url }}</a></td>#}
    {#        <td>{{ file.file.size | filesizeformat }}</td>#}
    {#        <td>{{ file.upload_method }}</td>#}
    {#    </tr>#}
    {#    {% endfor %}#}
    {#    </tbody>#}
    {#</table>#}
    {##}
    {#{% else %}#}
    {#<p>No files uploaded yet. Please click <a href="{% url 'file_upload:file_upload' %}">here</a>#}
    {#    to upload files.</p>#}
    {#{% endif %}#}

{% endblock  %}

{% block JScontent %}
    <script src="{% static "js/pdfjs/pdf.js" %}"></script>
    <script src="{% static "js/pdfjs/pdf.worker.js" %}"></script>
    <script>
    {#-------------開始時載入pdf-------------#}
    let current_page=1;
    let total_page='';
    {% if files.readme %}
    var url = "{{ files.readme.url }}";
    {% else %}
    var url = "";
    {% endif %}
    window.onload = pdfBox(current_page);

    {#-------------判斷螢幕縮放-------------#}
    var rtime;
    var timeout = false;
    var delta = 200;
    $(window).resize(function() {
        rtime = new Date();
        if (timeout === false) {
            timeout = true;
            setTimeout(resizeend, delta);
        }
    });

    function resizeend() {
        if (new Date() - rtime < delta) {
            setTimeout(resizeend, delta);
        } else {
            timeout = false;
            pdfBox(current_page)
        }
    }
    {#-------------pdf主程式-------------#}
    function pdfURL() {
        window.open(url);
    }
    function previousPage() {
        if (current_page !== 1) {
            current_page -= 1;
            pdfBox(current_page);
        }
    }
    function nextPage() {
        if (current_page !== total_page) {
            current_page += 1;
            pdfBox(current_page);
        }
    }
    function pdfBox(page) {
        var loadingTask = pdfjsLib.getDocument(url);
        loadingTask.promise.then(function (pdf) {
            console.log('PDF loaded');
            var pageNumber = page;
            $('#total_page').text(pdf.numPages);
            total_page = pdf.numPages;
            pdf.getPage(pageNumber).then(function (page) {
                console.log('page載入完成');
                // Prepare canvas using PDF page dimensions
                var container = document.getElementById('pdf-box');
                var canvas = document.getElementById('the-canvas');
                var context = canvas.getContext('2d');

                var viewport = page.getViewport(1);
                var scale = container.clientWidth / viewport.width;
                viewport = page.getViewport(scale);

                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Render PDF page into canvas context
                var renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                var renderTask = page.render(renderContext);
                renderTask.promise.then(function () {
                    console.log('pdf渲染完成');
                });
            });
            if (pdf.numPages > 1) {
                if (current_page === 1) {
                    $('#previous_button').css({'color':'#4d4d4d','cursor':'default'});
                } else {
                    $('#previous_button').css({'color':'#FF6722','cursor':'pointer'});
                }

                if (current_page === pdf.numPages) {
                    $('#next_button').css({'color':'#4d4d4d','cursor':'default'});
                } else {
                    $('#next_button').css({'color':'#FF6722','cursor':'pointer'});
                }
            }
            $('#current_page').text(current_page)
        }, function (reason) {
            // PDF loading error
            console.log(reason);
        });
    }
    </script>
{% endblock %}

